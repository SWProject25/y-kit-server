name: Spring Boot Production Deploy

on:
  push:
    branches:
      - main # main 브랜치에 코드를 푸시할 때마다 실행

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest # GitHub Actions가 빌드를 수행할 환경

    steps:
      - name: 1. Checkout Code (코드 가져오기)
        uses: actions/checkout@v4

      - name: 2. Set up JDK 21 (자바 빌드 환경 설정)
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: 3. Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: 4. Build with Gradle (JAR 파일 생성)
        run: ./gradlew clean build -x test

      - name: 5. Deploy to KT Cloud VM (VM 접속 및 배포)
        # SSH 접속 및 스크립트 실행을 위한 액션
        uses: appleboy/ssh-action@v1.0.3
        with:
          # GitHub Secrets에 등록된 정보 사용
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # .github/workflows/deploy.yml (Deploy to KT Cloud VM 단계의 script 내용)

          script: |
            # 1. 변수 정의: 실제 빌드되는 JAR 파일 이름으로 수정!
            PROJECT_NAME="y-kit-0.0.1-SNAPSHOT.jar" # <-- 실제 JAR 파일 이름으로 수정
            
            echo "Deployment started..."
            
            # 2. 필수 경로 변수 정의
            DEPLOY_DIR="/home/ubuntu/app/deploy"
            COMPOSE_DIR="/home/ubuntu/project_deploy"
            CONFIG_ENV="$COMPOSE_DIR/config.env"
            
            # 3. Firebase JSON 파일 경로 정의 (VM 내부 경로)
            FIREBASE_CONFIG_PATH="$COMPOSE_DIR/service-account.json"
            
            # ===================================================================
            # 4. VM에 config.env 파일 동적 생성/덮어쓰기 (Secret 주입)
            #    첫 번째 echo는 파일 생성, 나머지는 >>로 추가
            # ===================================================================

            echo "--- Writing Environment Variables to $CONFIG_ENV ---"

            # A. DB Secrets
            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}" > $CONFIG_ENV
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $CONFIG_ENV

            # B. OAuth Secrets
            echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> $CONFIG_ENV
            echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> $CONFIG_ENV
            
            # C. Custom & JWT Secrets
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $CONFIG_ENV
            
            # D. External API Endpoints & Keys
            echo "OPENAI_API_BASE_URL=${{ secrets.OPENAI_API_BASE_URL }}" >> $CONFIG_ENV
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $CONFIG_ENV
            echo "OPENAI_API_MODEL=${{ secrets.OPENAI_API_MODEL }}" >> $CONFIG_ENV

            echo "POLICY_API_KEY=${{ secrets.POLICY_API_KEY }}" >> $CONFIG_ENV
            echo "POLICY_API_URL=${{ secrets.POLICY_API_URL }}" >> $CONFIG_ENV
            
            echo "PUBLIC_RESOURCE_API_KEY=${{ secrets.PUBLIC_RESOURCE_API_KEY }}" >> $CONFIG_ENV
            echo "PUBLIC_RESOURCE_API_URL=${{ secrets.PUBLIC_RESOURCE_API_URL }}" >> $CONFIG_ENV
            
            echo "VWORLD_API_KEY=${{ secrets.VWORLD_API_KEY }}" >> $CONFIG_ENV
            echo "VWORLD_API_URL=${{ secrets.VWORLD_API_URL }}" >> $CONFIG_ENV

            # E. Service & Redirect URL (운영 환경 주소)
            # Secret에 등록된 도메인/IP를 기반으로 설정
            echo "SERVICE_DOMAIN_URL=${{ secrets.SERVICE_DOMAIN_URL }}" >> $CONFIG_ENV
            echo "APP_OAUTH2_REDIRECT_URL=http://${{ secrets.SERVICE_DOMAIN_URL }}/api/v1/auth/oauth2/success" >> $CONFIG_ENV
            
            # F. Firebase Config Path (JSON 파일 경로)
            echo "FIREBASE_CONFIG_PATH=$FIREBASE_CONFIG_PATH" >> $CONFIG_ENV
            
            # G. Spring Profiles (prod 활성화)
            echo "SPRING_PROFILES_ACTIVE=prod" >> $CONFIG_ENV
            
            # ===================================================================
            # 5. Firebase JSON 파일 생성 및 Secret 주입
            # ===================================================================
            # GitHub Secret 내용을 읽어 VM 내부에 service-account.json 파일로 저장
            echo "${{ secrets.FIREBASE_JSON }}" > $FIREBASE_CONFIG_PATH
            echo "Firebase config file created."

            # ===================================================================
            # 6. JAR 파일 복사 및 서버 재시작
            # ===================================================================
            
            # JAR 파일을 VM의 배포 경로로 복사 (이름을 app.jar로 통일)
            scp ./build/libs/$PROJECT_NAME \
                ubuntu@${{ secrets.HOST_IP }}:/home/ubuntu/app/deploy/app.jar
            
            # Docker Compose가 있는 경로로 이동
            cd $COMPOSE_DIR
            
            # 백엔드 컨테이너만 강제 재시작 (새 JAR 파일과 새 환경 변수 로드)
            docker-compose up -d --force-recreate backend 
            
            echo "Deployment complete! Server is running."