name: Spring Boot Production Deploy

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: 3. Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: 4. Build with Gradle (JAR ìƒì„±)
        run: ./gradlew clean build -x test

      - name: 5. Transfer JAR to KT Cloud VM (JAR íŒŒì¼ ì „ì†¡)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./build/libs/*.jar"
          target: "/home/ubuntu/app/deploy/"

      - name: 6. Restart Server via SSH (í™˜ê²½ ë³€ìˆ˜ ì£¼ìž… + ë°°í¬)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          script: |
            echo "ðŸš€ Deployment started..."
            
            # -----------------------------
            # 1. ë””ë ‰í† ë¦¬ ë° ë³€ìˆ˜ ì„¤ì • ë° ê¶Œí•œ ì •ë¦¬ (ê°•í™”)
            # -----------------------------
            DEPLOY_DIR="/home/ubuntu/app/deploy"
            COMPOSE_DIR="/root/y_kit_deploy"
            CONFIG_ENV="$COMPOSE_DIR/config.env"
            FIREBASE_CONFIG_PATH="$COMPOSE_DIR/service-account.json" 
            JAR_PATH="$DEPLOY_DIR/app.jar" # ìµœì¢… ì‹¤í–‰ë  íŒŒì¼ëª…
            SSH_USER="ubuntu" # SSH ì ‘ì† ì‚¬ìš©ìžëª…
            
            mkdir -p $DEPLOY_DIR
            mkdir -p $COMPOSE_DIR
            
            # DEPLOY_DIR ë° í•˜ìœ„ íŒŒì¼ì˜ ì†Œìœ ê¶Œì„ SSH ì ‘ì† ì‚¬ìš©ìž (ubuntu)ì—ê²Œ ì„¤ì •
            chown -R $SSH_USER:$SSH_USER $DEPLOY_DIR
            chown -R $SSH_USER:$SSH_USER $COMPOSE_DIR
            
            echo "âœ“ Directory ownership fixed for $SSH_USER"
            
            # -----------------------------
            # 2. ì „ì†¡ëœ JAR íŒŒì¼ íƒìƒ‰ ë° ì •ë¦¬ (ê°•í™”)
            # -----------------------------
            echo "ðŸ” Searching for transferred JAR file..."
            
            # 2.1. app.jar ì´ë¦„ìœ¼ë¡œ ì¡´ìž¬í•˜ëŠ” ë””ë ‰í† ë¦¬ê°€ ìžˆë‹¤ë©´ ê°•ì œ ì‚­ì œ
            if [ -d "$JAR_PATH" ]; then
                echo "âš ï¸ Existing app.jar is a directory! Deleting it forcefully."
                rm -rf "$JAR_PATH"
            fi
            
            # 2.2. ê°€ìž¥ ìµœê·¼ì— ì „ì†¡ëœ .jar íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤.
            # *ì£¼ì˜: $DEPLOY_DIR ì•ˆì— ì „ì†¡ëœ JAR íŒŒì¼ê³¼ app.jar ë§Œ ìžˆì–´ì•¼ í•©ë‹ˆë‹¤.*
            JAR_ORIGINAL=$(find $DEPLOY_DIR -maxdepth 1 -type f -name "*.jar" -not -name "app.jar" -printf "%T@ %p\n" | sort -n | tail -1 | awk '{print $2}')
            
            # ë§Œì•½ ìƒˆë¡œìš´ JAR íŒŒì¼ì´ ì—†ë‹¤ë©´, ì´ì „ app.jar íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
            if [ -z "$JAR_ORIGINAL" ]; then
                if [ -f "$JAR_PATH" ]; then
                    echo "â„¹ï¸ No new JAR found. Reusing existing $JAR_PATH."
                    JAR_ORIGINAL=$JAR_PATH
                else
                    echo "âŒ ERROR: No new or existing JAR file found in $DEPLOY_DIR"
                    exit 1
                fi
            fi
            
            echo "âœ“ Found target JAR: $JAR_ORIGINAL"
            
            # 2.3. ë””ë²„ê¹… ì¶œë ¥: íŒŒì¼ í¬ê¸° ë° íƒ€ìž… í™•ì¸
            echo "â„¹ï¸ Transferred file details:"
            ls -l "$JAR_ORIGINAL"
            # file ëª…ë ¹ì´ ì—†ìœ¼ë©´ ì„¤ì¹˜ê°€ í•„ìš”í•  ìˆ˜ ìžˆìœ¼ë¯€ë¡œ, ì¼ë‹¨ íŒŒì¼ í¬ê¸°ë§Œ í™•ì¸
            # file "$JAR_ORIGINAL" 
            
            # 2.4. ë°œê²¬í•œ JARë¥¼ app.jarë¡œ ì´ë™ (rename) ë° ê¶Œí•œ ìž¬ì„¤ì •
            if [ "$JAR_ORIGINAL" != "$JAR_PATH" ]; then
                rm -f $JAR_PATH # ì´ì „ íŒŒì¼ëª…ìœ¼ë¡œ ë‚¨ì•„ìžˆì„ ìˆ˜ ìžˆëŠ” íŒŒì¼ ì‚­ì œ
                mv "$JAR_ORIGINAL" "$JAR_PATH"
                chown $SSH_USER:$SSH_USER "$JAR_PATH" # ì†Œìœ ê¶Œ ìž¬í™•ë³´
                chmod +x "$JAR_PATH"
                echo "âœ“ JAR moved and renamed to $JAR_PATH"
            fi
            
            echo "âœ“ Final JAR file path: $JAR_PATH"
            ls -l $JAR_PATH

            # -----------------------------
            # 3. config.env íŒŒì¼ ìƒì„±
            # -----------------------------
            echo "ðŸ“ Writing config.env ..."

            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}" > $CONFIG_ENV
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $CONFIG_ENV
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $CONFIG_ENV

            echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> $CONFIG_ENV
            echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> $CONFIG_ENV
            echo "APP_OAUTH2_REDIRECT_URL=http://${{ secrets.SERVICE_DOMAIN_URL }}/api/v1/auth/oauth2/success" >> $CONFIG_ENV

            echo "FIREBASE_CONFIG_PATH=$FIREBASE_CONFIG_PATH" >> $CONFIG_ENV

            echo "OPENAI_API_BASE_URL=${{ secrets.OPENAI_API_BASE_URL }}" >> $CONFIG_ENV
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $CONFIG_ENV
            echo "OPENAI_API_MODEL=${{ secrets.OPENAI_API_MODEL }}" >> $CONFIG_ENV
            echo "POLICY_API_KEY=${{ secrets.POLICY_API_KEY }}" >> $CONFIG_ENV
            echo "POLICY_API_URL=${{ secrets.POLICY_API_URL }}" >> $CONFIG_ENV
            echo "PUBLIC_RESOURCE_API_KEY=${{ secrets.PUBLIC_RESOURCE_API_KEY }}" >> $CONFIG_ENV
            echo "PUBLIC_RESOURCE_API_URL=${{ secrets.PUBLIC_RESOURCE_API_URL }}" >> $CONFIG_ENV
            echo "VWORLD_API_KEY=${{ secrets.VWORLD_API_KEY }}" >> $CONFIG_ENV
            echo "VWORLD_API_URL=${{ secrets.VWORLD_API_URL }}" >> $CONFIG_ENV

            echo "SPRING_PROFILES_ACTIVE=prod" >> $CONFIG_ENV

            echo "âœ“ config.env created"

            # -----------------------------
            # 4. Firebase JSON ìƒì„±
            # -----------------------------
            echo "${{ secrets.FIREBASE_JSON }}" > $FIREBASE_CONFIG_PATH
            echo "âœ“ Firebase config created"

            # -----------------------------
            # 5. Docker Compose ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
            # -----------------------------
            echo "ðŸ”„ Restarting Docker Compose service..."

            cd $COMPOSE_DIR
            docker-compose up -d --force-recreate server

            echo "ðŸŽ‰ Deployment complete!"