name: Spring Boot Production Deploy

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Code (ì½”ë“œ ê°€ì ¸ì˜¤ê¸°)
        uses: actions/checkout@v4

      - name: 2. Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: 3. Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: 4. Build with Gradle (JAR íŒŒì¼ ìƒì„±)
        run: ./gradlew clean build -x test

      - name: 5. Transfer JAR to KT Cloud VM (JAR íŒŒì¼ ì „ì†¡)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # JAR íŒŒì¼ì„ ì›ë³¸ ì´ë¦„ ê·¸ëŒ€ë¡œ VMì˜ deploy í´ë”ë¡œ ì „ì†¡
          source: "./build/libs/y-kit-0.0.1-SNAPSHOT.jar"
          target: "/home/ubuntu/app/deploy/"

      - name: 5.5 Transfer Docker Compose Files (ì„¤ì • íŒŒì¼ ì „ì†¡)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # docker-compose.yml ë° nginx í´ë” ì „ì²´ ì „ì†¡
          source: "docker-compose.yml, nginx"
          target: "/root/y_kit_deploy/"

      - name: 6. Restart Server via SSH (í™˜ê²½ ë³€ìˆ˜ ì£¼ìž… ë° ì„œë²„ ìž¬ì‹œìž‘)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          script: |
            set -e # â¬…ï¸ âš ï¸ í•„ìˆ˜: ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨ ë° ì‹¤íŒ¨ ë³´ê³ 
            
            echo "ðŸš€ Deployment started..."
            
            # 1. ë³€ìˆ˜ ì •ì˜ ë° ê²½ë¡œ ì„¤ì •
            COMPOSE_DIR="/root/y_kit_deploy"
            DEPLOY_DIR="/home/ubuntu/app/deploy"
            CONFIG_ENV="$COMPOSE_DIR/config.env"
            FIREBASE_CONFIG_PATH="$COMPOSE_DIR/service-account.json" 
            JAR_PATH="$DEPLOY_DIR/app.jar" # ìµœì¢… JAR íŒŒì¼ëª…

            # 2. í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
            mkdir -p $COMPOSE_DIR 
            
            # deploy ë””ë ‰í† ë¦¬ ê¶Œí•œì„ ubuntuë¡œ í†µì¼ (JAR íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ ë¬¸ì œ í•´ê²°)
            chown -R ubuntu:ubuntu $DEPLOY_DIR
            echo "âœ“ Directory ownership fixed"

            # 3. ìžë™ JAR íŒŒì¼ íƒìƒ‰ ë° ì´ë™ (íŒŒì¼ëª… í†µì¼)
            echo "ðŸ” Searching for JAR file..."
            
            # *.jar íŒŒì¼ì„ ì°¾ê³  ê°€ìž¥ ìµœì‹  íŒŒì¼ í•˜ë‚˜ë¥¼ ì„ íƒ
            JAR_ORIGINAL=$(find $DEPLOY_DIR -maxdepth 1 -name "*.jar" | head -n 1)

            if [ -z "$JAR_ORIGINAL" ]; then
              echo "âŒ ERROR: No JAR file found in $DEPLOY_DIR"
              exit 1
            fi

            # ì´ì „ app.jar ì‚­ì œ (mv ëª…ë ¹ì´ ì˜¤ë¥˜ë‚  ê²½ìš° ëŒ€ë¹„)
            rm -f $JAR_PATH

            # ë°œê²¬í•œ JARë¥¼ app.jarë¡œ ì´ë™ (ì´ë¦„ í†µì¼)
            mv "$JAR_ORIGINAL" "$JAR_PATH"
            
            # 4. JAR íŒŒì¼ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ (VMì˜ íŒŒì¼ ê¶Œí•œ ë¬¸ì œ í•´ê²°)
            chmod +x "$JAR_PATH"
            echo "âœ“ JAR renamed and execution permission granted"
            
            # 5. config.env íŒŒì¼ ë™ì  ìƒì„± ë° Secret ì£¼ìž…
            echo "--- Writing Environment Variables ---"

            # A. DB ë° ê³µí†µ Secrets
            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}" > $CONFIG_ENV
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $CONFIG_ENV
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $CONFIG_ENV

            # B. OAuth & Redirect URL
            echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> $CONFIG_ENV
            echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> $CONFIG_ENV
            echo "APP_OAUTH2_REDIRECT_URL=http://${{ secrets.SERVICE_DOMAIN_URL }}/api/v1/auth/oauth2/success" >> $CONFIG_ENV
            
            # C. Firebase Config Path
            echo "FIREBASE_CONFIG_PATH=$FIREBASE_CONFIG_PATH" >> $CONFIG_ENV

            # D. ì™¸ë¶€ API Keys
            echo "OPENAI_API_BASE_URL=${{ secrets.OPENAI_API_BASE_URL }}" >> $CONFIG_ENV
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $CONFIG_ENV
            echo "OPENAI_API_MODEL=${{ secrets.OPENAI_API_MODEL }}" >> $CONFIG_ENV
            echo "POLICY_API_KEY=${{ secrets.POLICY_API_KEY }}" >> $CONFIG_ENV
            echo "POLICY_API_URL=${{ secrets.POLICY_API_URL }}" >> $CONFIG_ENV
            echo "PUBLIC_RESOURCE_API_KEY=${{ secrets.PUBLIC_RESOURCE_API_KEY }}" >> $CONFIG_ENV
            echo "PUBLIC_RESOURCE_API_URL=${{ secrets.PUBLIC_RESOURCE_API_URL }}" >> $CONFIG_ENV
            echo "VWORLD_API_KEY=${{ secrets.VWORLD_API_KEY }}" >> $CONFIG_ENV
            echo "VWORLD_API_URL=${{ secrets.VWORLD_API_URL }}" >> $CONFIG_ENV
            
            # E. Spring Profiles
            echo "SPRING_PROFILES_ACTIVE=prod" >> $CONFIG_ENV
            
            # 6. Firebase JSON íŒŒì¼ ìƒì„±
            echo "${{ secrets.FIREBASE_JSON }}" > $FIREBASE_CONFIG_PATH
            echo "âœ“ Firebase config file created."

            # 7. Docker Compose ìž¬ì‹œìž‘
            echo "ðŸ”„ Restarting Docker Compose service..."
            cd $COMPOSE_DIR
            docker-compose up -d --force-recreate server 
            
            echo "ðŸŽ‰ Deployment complete!"