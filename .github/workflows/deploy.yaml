name: Spring Boot Production Deploy

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Set up JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle permissions
      - name: Grant execute permission to gradlew
        run: chmod +x gradlew

      # 4. Build Spring Boot fat JAR
      - name: Build with Gradle
        run: ./gradlew clean bootJar -x test

      # 5. Debug: Check built JAR exists
      - name: Check built JAR files
        run: |
          echo "=== build/libs ==="
          ls -al ./build/libs

      # 6. Transfer JAR to VM
      - name: Transfer JAR to KT Cloud VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "${{ github.workspace }}/build/libs/*.jar"
          target: "/home/ubuntu/app/deploy/"

      # 7. SSH â€” Deploy (ëª¨ë“  í™˜ê²½ ì„¤ì • ë° ì¬ì‹œì‘ ë¡œì§ í¬í•¨)
      - name: Restart Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Deployment started..."
            
            DEPLOY_DIR="/home/ubuntu/app/deploy"
            COMPOSE_DIR="/root/y_kit_deploy"
            CONFIG_ENV="$COMPOSE_DIR/config.env"
            FIREBASE_CONFIG_PATH="$COMPOSE_DIR/service-account.json"
            JAR_PATH="$DEPLOY_DIR/app.jar"
            
            mkdir -p $DEPLOY_DIR
            mkdir -p $COMPOSE_DIR
            
            # ê¶Œí•œ ì •ë¦¬
            chown -R ubuntu:ubuntu $DEPLOY_DIR
            chown -R root:root $COMPOSE_DIR
            
            echo "ğŸ” Checking transferred files..."
            ls -al $DEPLOY_DIR
            
            # ìµœì‹  JAR ì„ íƒ
            JAR_ORIGINAL=$(find $DEPLOY_DIR -type f -name "*.jar" ! -name "app.jar" | sort | tail -n 1)
            
            if [ -z "$JAR_ORIGINAL" ]; then
                echo "âŒ ERROR: No new JAR found"
                exit 1
            fi
            
            echo "Found JAR: $JAR_ORIGINAL"
            
            # ê¸°ì¡´ app.jar ì‚­ì œ
            rm -f $JAR_PATH
            
            # ì´ë™ ë° ê¶Œí•œ ì„¤ì •
            mv "$JAR_ORIGINAL" "$JAR_PATH"
            chmod +x "$JAR_PATH"
            
            echo "âœ“ JAR updated at $JAR_PATH"
            
            # config.env ìƒì„± (ğŸš¨ ì™„ë²½í•˜ê²Œ ì •ë¦¬ëœ Heredoc êµ¬ë¬¸)
            echo "ğŸ“ Creating config.env..."
            cat <<EOF > $CONFIG_ENV
            DB_URL='${{ secrets.DB_URL }}'
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
            APP_OAUTH2_REDIRECT_URL=http://${{ secrets.SERVICE_DOMAIN_URL }}/api/v1/auth/oauth2/success
            FIREBASE_CONFIG_PATH=$FIREBASE_CONFIG_PATH
            OPENAI_API_BASE_URL=${{ secrets.OPENAI_API_BASE_URL }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            OPENAI_API_MODEL=${{ secrets.OPENAI_API_MODEL }}
            POLICY_API_KEY=${{ secrets.POLICY_API_KEY }}
            POLICY_API_URL=${{ secrets.POLICY_API_URL }}
            PUBLIC_RESOURCE_API_KEY=${{ secrets.PUBLIC_RESOURCE_API_KEY }}
            PUBLIC_RESOURCE_API_URL=${{ secrets.PUBLIC_RESOURCE_API_URL }}
            VWORLD_API_KEY=${{ secrets.VWORLD_API_KEY }}
            VWORLD_API_URL=${{ secrets.VWORLD_API_URL }}
            EOF
  
            echo "âœ“ config.env created"
            
            # DB_URL í˜¸ìŠ¤íŠ¸ ì´ë¦„ ì¹˜í™˜ (localhost -> db)
            sed -i 's/localhost/db/g' $CONFIG_ENV
            echo "âœ“ DB_URL host (localhost) replaced with 'db' in config.env"
            
            # DB_URL ìµœì¢… ê°’ ë””ë²„ê¹… ì¶œë ¥ (ë¡œê·¸ í™•ì¸ìš©)
            echo "ğŸ” Current DB_URL is:"
            grep DB_URL $CONFIG_ENV
            
            # Firebase JSON ìƒì„± (base64 decode)
            echo "ğŸ“ Creating Firebase service-account.json..."
            echo '${{ secrets.FIREBASE_JSON }}' > $FIREBASE_CONFIG_PATH # â¬…ï¸ Secret ì´ë¦„ì´ FIREBASE_JSONìœ¼ë¡œ ë³€ê²½ë¨
            echo "âœ“ Firebase JSON created"
            
            # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (Docker Composeê°€ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡)
            source $CONFIG_ENV
            echo "âœ“ Environment variables loaded into shell"
            
            # Docker Compose ì¬ì‹œì‘
            cd $COMPOSE_DIR
            echo "ğŸ”„ Restarting Docker Compose..."
            docker compose down
            docker compose up -d --force-recreate
            
            echo "ğŸ‰ Deployment Complete!"