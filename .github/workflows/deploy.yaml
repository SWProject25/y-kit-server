name: Spring Boot Production Deploy

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Set up JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle permissions
      - name: Grant execute permission to gradlew
        run: chmod +x gradlew

      # 4. Build Spring Boot fat JAR
      - name: Build with Gradle
        run: ./gradlew clean bootJar -x test

      # 5. Debug: Check built JAR exists
      - name: Check built JAR files
        run: |
          echo "=== build/libs ==="
          ls -al ./build/libs

      # 6. Transfer JAR to VM
      - name: Transfer JAR to KT Cloud VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "${{ github.workspace }}/build/libs/*.jar"
          target: "/home/ubuntu/app/deploy/"

      # 7. SSH ‚Äî Deploy
      - name: Restart Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ Deployment started..."

            DEPLOY_DIR="/home/ubuntu/app/deploy"
            COMPOSE_DIR="/root/y_kit_deploy"
            CONFIG_ENV="$COMPOSE_DIR/config.env"
            FIREBASE_CONFIG_PATH="$COMPOSE_DIR/service-account.json"
            JAR_PATH="$DEPLOY_DIR/app.jar"

            mkdir -p $DEPLOY_DIR
            mkdir -p $COMPOSE_DIR

            # Í∂åÌïú Ï†ïÎ¶¨
            chown -R ubuntu:ubuntu $DEPLOY_DIR
            chown -R root:root $COMPOSE_DIR

            echo "üîç Checking transferred files..."
            ls -al $DEPLOY_DIR

            # ÏµúÏã† JAR ÏÑ†ÌÉù
            JAR_ORIGINAL=$(find $DEPLOY_DIR -type f -name "*.jar" ! -name "app.jar" | sort | tail -n 1)

            if [ -z "$JAR_ORIGINAL" ]; then
              echo "‚ùå ERROR: No new JAR found"
              exit 1
            fi

            echo "Found JAR: $JAR_ORIGINAL"

            # Í∏∞Ï°¥ app.jar ÏÇ≠Ï†ú
            rm -f $JAR_PATH

            # Ïù¥Îèô Î∞è Í∂åÌïú ÏÑ§Ï†ï
            mv "$JAR_ORIGINAL" "$JAR_PATH"
            chmod +x "$JAR_PATH"

            echo "‚úì JAR updated at $JAR_PATH"

            # config.env ÏÉùÏÑ±
            echo "üìù Creating config.env..."
            cat <<EOF > $CONFIG_ENV
              SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}
              SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
              JWT_SECRET=${{ secrets.JWT_SECRET }}
              KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
              KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
              APP_OAUTH2_REDIRECT_URL=http://${{ secrets.SERVICE_DOMAIN_URL }}/api/v1/auth/oauth2/success
              FIREBASE_CONFIG_PATH=$FIREBASE_CONFIG_PATH
              OPENAI_API_BASE_URL=${{ secrets.OPENAI_API_BASE_URL }}
              OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
              OPENAI_API_MODEL=${{ secrets.OPENAI_API_MODEL }}
              POLICY_API_KEY=${{ secrets.POLICY_API_KEY }}
              POLICY_API_URL=${{ secrets.POLICY_API_URL }}
              PUBLIC_RESOURCE_API_KEY=${{ secrets.PUBLIC_RESOURCE_API_KEY }}
              PUBLIC_RESOURCE_API_URL=${{ secrets.PUBLIC_RESOURCE_API_URL }}
              VWORLD_API_KEY=${{ secrets.VWORLD_API_KEY }}
              VWORLD_API_URL=${{ secrets.VWORLD_API_URL }}
              SPRING_PROFILES_ACTIVE=prod
            EOF
  
            echo "‚úì config.env created"
            
            # Firebase JSON ÏÉùÏÑ± (base64 decode)
            echo "${{ secrets.FIREBASE_JSON_BASE64 }}" | base64 -d > $FIREBASE_CONFIG_PATH
            echo "‚úì Firebase JSON created"
            
            # Docker Compose Ïû¨ÏãúÏûë
            cd $COMPOSE_DIR
            echo "üîÑ Restarting Docker Compose..."
            docker compose down
            docker compose up -d --force-recreate
            
            echo "üéâ Deployment Complete!"
