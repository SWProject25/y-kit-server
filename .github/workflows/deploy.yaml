name: Spring Boot Production Deploy

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: 3. Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: 4. Build with Gradle (JAR ìƒì„±)
        run: ./gradlew clean build -x test

      - name: 5. Transfer JAR to KT Cloud VM (JAR íŒŒì¼ ì „ì†¡)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./build/libs/*.jar"
          target: "/home/ubuntu/app/deploy/"

      - name: 6. Restart Server via SSH (í™˜ê²½ ë³€ìˆ˜ ì£¼ìž… + ë°°í¬)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          script: |
            echo "ðŸš€ Deployment started..."

            # 1. ë””ë ‰í† ë¦¬ ë° ê¶Œí•œ ì •ë¦¬
            DEPLOY_DIR="/home/ubuntu/app/deploy"
            COMPOSE_DIR="/root/y_kit_deploy"
            CONFIG_ENV="$COMPOSE_DIR/config.env"
            FIREBASE_CONFIG_PATH="$COMPOSE_DIR/service-account.json" 
            JAR_PATH="$DEPLOY_DIR/app.jar"

            mkdir -p $DEPLOY_DIR
            mkdir -p $COMPOSE_DIR

            # deploy ë””ë ‰í† ë¦¬ ê¶Œí•œì„ ubuntuë¡œ í†µì¼
            chown -R ubuntu:ubuntu $DEPLOY_DIR

            echo "âœ“ Directory ownership fixed"

            # 2. ìžë™ JAR íŒŒì¼ íƒìƒ‰
            echo "ðŸ” Searching for JAR file..."

            JAR_ORIGINAL=$(find $DEPLOY_DIR -type f -name "*.jar" | head -n 1)

            if [ -z "$JAR_ORIGINAL" ]; then
              echo "âŒ ERROR: No JAR file found in $DEPLOY_DIR"
              exit 1
            fi

            echo "âœ“ Found JAR: $JAR_ORIGINAL"

            # ì´ì „ app.jar ì‚­ì œ
            rm -f $JAR_PATH

            # ë°œê²¬í•œ JARë¥¼ app.jarë¡œ ì´ë™
            mv "$JAR_ORIGINAL" "$JAR_PATH"
            chmod +x "$JAR_PATH"

            echo "âœ“ JAR moved to $JAR_PATH"

            # 3. config.env íŒŒì¼ ìƒì„±
            echo "ðŸ“ Writing config.env ..."

            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}" > $CONFIG_ENV
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $CONFIG_ENV
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $CONFIG_ENV

            echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> $CONFIG_ENV
            echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> $CONFIG_ENV
            echo "APP_OAUTH2_REDIRECT_URL=http://${{ secrets.SERVICE_DOMAIN_URL }}/api/v1/auth/oauth2/success" >> $CONFIG_ENV

            echo "FIREBASE_CONFIG_PATH=$FIREBASE_CONFIG_PATH" >> $CONFIG_ENV

            echo "OPENAI_API_BASE_URL=${{ secrets.OPENAI_API_BASE_URL }}" >> $CONFIG_ENV
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $CONFIG_ENV
            echo "OPENAI_API_MODEL=${{ secrets.OPENAI_API_MODEL }}" >> $CONFIG_ENV
            echo "POLICY_API_KEY=${{ secrets.POLICY_API_KEY }}" >> $CONFIG_ENV
            echo "POLICY_API_URL=${{ secrets.POLICY_API_URL }}" >> $CONFIG_ENV
            echo "PUBLIC_RESOURCE_API_KEY=${{ secrets.PUBLIC_RESOURCE_API_KEY }}" >> $CONFIG_ENV
            echo "PUBLIC_RESOURCE_API_URL=${{ secrets.PUBLIC_RESOURCE_API_URL }}" >> $CONFIG_ENV
            echo "VWORLD_API_KEY=${{ secrets.VWORLD_API_KEY }}" >> $CONFIG_ENV
            echo "VWORLD_API_URL=${{ secrets.VWORLD_API_URL }}" >> $CONFIG_ENV

            echo "SPRING_PROFILES_ACTIVE=prod" >> $CONFIG_ENV

            echo "âœ“ config.env created"

            # 4. Firebase JSON ìƒì„±
            echo "${{ secrets.FIREBASE_JSON }}" > $FIREBASE_CONFIG_PATH
            echo "âœ“ Firebase config created"

            # 5. Docker Compose ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
            echo "ðŸ”„ Restarting Docker Compose service..."

            cd $COMPOSE_DIR
            docker-compose up -d --force-recreate server

            echo "ðŸŽ‰ Deployment complete!"